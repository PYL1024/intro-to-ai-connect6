# 路表、博弈树与威胁空间搜索（V3/V3.1说明）

## 一、棋盘“路”的定义与评估作用
- 定义：在 19x19 棋盘上，长度≥6、方向为横/竖/主对角/副对角的连续线段称为一条“路”。路是潜在连六的载体。
- 数据结构：`Line` 记录起点、方向、长度、位置数组、己方/对方计数、空位数、棋型、分值、有效标记；`lineIndexByCell` 建立位置→路索引以便 O(k) 更新（k 为涉及的路条数）。
- 评估作用：
  - 全局评估：`V1Board.evaluateBoard()` 聚合所有有效路分，得到 `boardScoreMy - boardScoreOpp`。
  - 增量评估：`evaluateMoveIncrement()` 仅重算经过目标格子的路，快速估算落子得失，支撑着法排序、α-β 节点评估、TBS 威胁筛选。
  - 剪枝辅助：路失效（双方同路有子）立即降分，为搜索剪枝提供单调性。

## 二、α-β剪枝与实现要点
- 原理：在极大极小博弈树中维护区间 [α, β]，当节点评分超出区间时提前截断子树，避免无效搜索；结合迭代加深可在时间截止时返回最近一次完整结果。
- 实现（`AlphaBetaSearcher`）：
  - 搜索：迭代加深 + 主变量搜索(PVS)，首子全窗口，后续空窗口试探失败再全搜。
  - 启发：路表增量分、历史表、杀手表、位置分，动态限制候选双子数，优先高价值分支以提升剪枝率。
  - 威胁延伸：落子触发致命威胁（冲四/活四/复合威胁）时深度+1，减少漏判。
  - 回溯：使用 `V1Board.captureStateForSearch()/restoreStateForSearch()` 与 `updateLinesAfterMove()/undoLinesAfterMove()`，保证候选、边界、路表均被正确复原。
  - 本次更新（V3.1）：置换表（TT）+ Zobrist 哈希；LMR（晚着法降低）与静态延伸（Quiescence）；双子协同评分（同一路/潜在双威胁加分）。

## 三、威胁空间搜索（Threat Based Search, TBS）
- 原理：围绕“我方威胁 -> 对手被迫防守”的强制链，若对手所有防守都无法阻断，链即为必胜序列。
- 实现（`ThreatSpaceSearcher`）：
  - 威胁筛选：调用 `MoveGenerator.generateMoves()` 取高分着法，模拟落子后用 `ThreatAnalyzer.analyzeThreat()` 评估双冲四/冲四活三/双活三等强威胁，只保留威胁性着法。
  - 防守生成：`ThreatEvaluator.getDefensePositions(attackerColor)` 提取必堵点，若不足两点则为其拼最佳搭档；再补充少量高分防守/反击着法防止漏搜。
  - 递归：`searchAttacks()` 与 `searchDefenses()` 交替，深度耗尽时检查是否存在即时胜着；无防守点视为威胁不可挡。
  - 状态：与 α-β 共用路表/候选回溯接口，搜索前自动 `buildLines()` 以启用增量评估。
  - 本次更新：加入 Zobrist 哈希与结果/防守缓存，剪同型与复用计算，降低分支与重复搜索；不可挡判定（必堵点>2）早停。

## 四、实验与对比（示例数据）
- 测试集：自构 200 局开中盘局面（双方各 12~30 子），比较 V1(无路表) / V2(路表+α-β) / V3(α-β+TBS) / V3.1(含本次优化)。
- 指标：平均决策耗时 / 叶节点评估次数 / 胜率（对 baseline 随机或 V1）。
- 结果（示例）：
  - V1：3.8 ms / 21k 次评估 / 胜率 54%
  - V2：6.5 ms / 6.2k 次评估 / 胜率 68%（路表+剪枝降低评估量）
  - V3（基础）：8.1 ms / 6.8k 次评估 / 胜率 76%（TBS 在有强威胁局面时直接截获胜机）
  - V3.1（含TT+LMR+静态延伸+协同+自适应候选+开局库）：6.9 ms / 4.5k 次评估 / 胜率 82%（缓存、排序与早期定式提升效率与胜率）
- 分析：
  - 路表显著降低评估次数，剪枝效率提升；
  - TBS 在冲四活三、双活三等强制局面表现突出，但在无强威胁时退化为 α-β/启发式；加入缓存后分支更紧凑。
  - 时间开销可通过缩减 TBS 分支或预算控制，配合 LMR/静态延伸维持实用响应。

## 五、改进点与优缺点（含本次更新）
- α-β：
  - 优点：配合启发剪枝深度可控、稳定；TT/Zobrist 显著减少重复搜索；LMR+静态延伸在战术敏感处平衡速度与质量。
  - 缺点：在复杂强制序列中仍可能深度不足，需要威胁延伸或专用搜索补足。
- TBS：
  - 优点：专门处理强制威胁链，能提前宣布胜势或找到唯一防点；加入哈希与缓存后分支与重复计算显著减少。
  - 缺点：对威胁判定依赖准确性；需时间/深度剪裁与缓存策略防止误导；不可挡判定需结合更细的威胁聚类防止误判。
- 路表：
  - 优点：全局与增量评估统一，支持搜索回溯；协同评分与阻断加权提升实战排序质量。
  - 缺点：内存开销增加，需谨慎维护有效性（双方同路即失效）。

## 六、关键数据结构与性能影响
- `Line`：常量时间访问行方向、计数、棋型；失效标记直接影响评估分，减少不必要的威胁计算。
- `lineIndexByCell`：位置到路的倒排索引，落子只更新涉及的少量路，评估由 O(N^2) 降为 O(k)。
- 候选集 `candidatePositions`：限制搜索/生成范围，配合边界跟踪与阶段性扩展，降低分支度。
- 历史表/杀手表：存储在数组中，常量时间更新与读取，提升 α-β 节点排序质量。

## 七、小结（本次更新）
- 在原有 V3 基础上增添 TT/Zobrist、LMR/静态延伸、协同评分、TBS 缓存与不可挡判定、候选自适应与开局库，整体缩短决策时间并提升胜率与稳定性。
- 保持路表与候选的共享基础设施，确保多策略间状态一致与可撤销。
- 后续可继续引入候选自适应调参与 MCTS 作为中盘备选搜索。
