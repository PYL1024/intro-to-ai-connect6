# 路表、博弈树与威胁空间搜索（V3说明）

## 一、棋盘“路”的定义与评估作用
- 定义：在 19x19 棋盘上，长度≥6、方向为横/竖/主对角/副对角的连续线段称为一条“路”。路是潜在连六的载体。
- 数据结构：`Line` 记录起点、方向、长度、位置数组、己方/对方计数、空位数、棋型、分值、有效标记；`lineIndexByCell` 建立位置→路索引以便 O(k) 更新（k 为涉及的路条数）。
- 评估作用：
  - 全局评估：`V1Board.evaluateBoard()` 聚合所有有效路分，得到 `boardScoreMy - boardScoreOpp`。
  - 增量评估：`evaluateMoveIncrement()` 仅重算经过目标格子的路，快速估算落子得失，支撑着法排序、α-β 节点评估、TBS 威胁筛选。
  - 剪枝辅助：路失效（双方同路有子）立即降分，为搜索剪枝提供单调性。

## 二、α-β剪枝与实现要点
- 原理：在极大极小博弈树中维护区间 [α, β]，当节点评分超出区间时提前截断子树，避免无效搜索；结合迭代加深可在时间截止时返回最近一次完整结果。
- 实现（`AlphaBetaSearcher`）：
  - 搜索：迭代加深 + 主变量搜索(PVS)，首子全窗口，后续空窗口试探失败再全搜。
  - 启发：路表增量分、历史表、杀手表、位置分，限制候选双子数到 8 组，优先高价值分支以提升剪枝率。
  - 威胁延伸：落子触发致命威胁（冲四/活四/复合威胁）时深度+1，减少漏判。
  - 回溯：使用 `V1Board.captureStateForSearch()/restoreStateForSearch()` 与 `updateLinesAfterMove()/undoLinesAfterMove()`，保证候选、边界、路表均被正确复原。

## 三、威胁空间搜索（Threat Based Search, TBS）
- 原理：围绕“我方威胁 -> 对手被迫防守”的强制链，若对手所有防守都无法阻断，链即为必胜序列。
- 实现（`ThreatSpaceSearcher`）：
  - 威胁筛选：调用 `MoveGenerator.generateMoves()` 取高分着法，模拟落子后用 `ThreatAnalyzer.analyzeThreat()` 评估双冲四/冲四活三/双活三等强威胁，只保留威胁性着法。
  - 防守生成：`ThreatEvaluator.getDefensePositions(attackerColor)` 提取必堵点，若不足两点则为其拼最佳搭档；再补充少量高分防守/反击着法防止漏搜。
  - 递归：`searchAttacks()` 与 `searchDefenses()` 交替，深度耗尽时检查是否存在即时胜着；无防守点视为威胁不可挡。
  - 状态：与 α-β 共用路表/候选回溯接口，搜索前自动 `buildLines()` 以启用增量评估。

## 四、实验与对比（示例数据）
- 测试集：自构 200 局开中盘局面（双方各 12~30 子），比较 V1(无路表) / V2(路表+α-β) / V3(α-β+TBS)。
- 指标：平均决策耗时 / 叶节点评估次数 / 胜率（对 baseline 随机或 V1）。
- 结果（示例）：
  - V1：3.8 ms / 21k 次评估 / 胜率 54%
  - V2：6.5 ms / 6.2k 次评估 / 胜率 68%（路表+剪枝降低评估量）
  - V3：8.1 ms / 6.8k 次评估 / 胜率 76%（TBS 在有强威胁局面时直接截获胜机）
- 分析：
  - 路表显著降低评估次数，剪枝效率提升；
  - TBS 在冲四活三、双活三等强制局面表现突出，但在无强威胁时退化为 α-β/启发式。
  - 时间开销可通过缩减 TBS 分支或预算控制，维持实用响应。

## 五、改进点与优缺点
- α-β：
  - 优点：配合启发剪枝深度可控、稳定；
  - 缺点：在复杂强制序列中可能深度不足，需要威胁延伸或专用搜索补足。
- TBS：
  - 优点：专门处理强制威胁链，能提前宣布胜势或找到唯一防点；
  - 缺点：分支仍可能偏大，对威胁判定依赖准确性；需时间/深度剪裁防止拖慢决策。
- 路表：
  - 优点：全局与增量评估统一，支持搜索回溯；
  - 缺点：内存开销增加，需谨慎维护有效性（双方同路即失效）。

## 六、关键数据结构与性能影响
- `Line`：常量时间访问行方向、计数、棋型；失效标记直接影响评估分，减少不必要的威胁计算。
- `lineIndexByCell`：位置到路的倒排索引，落子只更新涉及的少量路，评估由 O(N^2) 降为 O(k)。
- 候选集 `candidatePositions`：限制搜索/生成范围，配合边界跟踪与阶段性扩展，降低分支度。
- 历史表/杀手表：存储在数组中，常量时间更新与读取，提升 α-β 节点排序质量。

## 七、小结
- V3 在 V2 基础上引入 TBS，形成“威胁驱动 + 剪枝搜索”双通路：有强威胁先走 TBS，无则回退 α-β/启发式。
- 路表、候选集与回溯快照构成共享基础设施，确保多种搜索策略之间状态一致、可撤销。
- 后续可加入自适应时间分配、并行 MCTS 对比、局部模式库等进一步提升表现。
